<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>E-Voting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/design.css"> 
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand w-100 text-center" href="#">E-Voting</a>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-7 col-lg-6">

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Voter Verification</h5>

                        <div id="alert-placeholder"></div>

                        <form id="license-form" class="mb-3" autocomplete="off">
                            <div class="mb-3">
                                <label for="license_id" class="form-label">License ID</label>
                                <input type="text" id="license_id" name="license_id" class="form-control" placeholder="Enter license ID" required>
                            </div>
                            <button class="btn btn-primary" id="check-btn" type="submit">Check License</button>
                        </form>

                        <form id="info-form" style="display:none;" autocomplete="off">
                            <h5 class="card-title mb-3">Cast Your Vote</h5>
                            <div class="mb-3">
                                <label for="name" class="form-label">Full Name</label>
                                <input type="text" id="name" name="name" class="form-control" placeholder="Full name" required>
                            </div>
                            <div class="mb-3">
                                <label for="cid" class="form-label">CID</label>
                                <input type="text" id="cid" name="cid" class="form-control" placeholder="CID" required>
                            </div>
                            <div class="mb-3">
                                <label for="selectInput" class="form-label">Vote for Candidate</label>
                                <select id="selectInput" class="form-select" required>
                                    <option value="">Select Your Option</option>
                                    <option value="Option A">Option A</option>
                                    <option value="Option B">Option B</option>
                                    <option value="Option C">Option C</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="submit-btn" type="submit">Submit Vote</button>
                            <button class="btn btn-secondary ms-2" id="cancel-btn" type="button">Cancel</button>
                        </form>

                    </div>
                </div>

                <div class="mt-3 text-center text-muted">
                    Instruction: Use /copy_license to get your License ID.
                </div>

            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Helper function to show messages using Bootstrap alerts
    function showAlert(message, type) {
        const placeholder = document.getElementById("alert-placeholder");
        placeholder.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
    }

    document.getElementById("license-form").addEventListener("submit", function(event) {
        event.preventDefault();
        checkLicense();
    });

    document.getElementById("info-form").addEventListener("submit", function(event) {
        event.preventDefault();
        submitForm();
    });

    document.getElementById("cancel-btn").addEventListener("click", function() {
        document.getElementById("info-form").style.display = 'none';
        document.getElementById("license-form").style.display = 'block';
        document.getElementById("alert-placeholder").innerHTML = ''; // Clear alerts
    });

    async function checkLicense() {
        const license_id = document.getElementById("license_id").value.trim();
        const infoForm = document.getElementById("info-form");
        const licenseForm = document.getElementById("license-form");

        document.getElementById("alert-placeholder").innerHTML = ''; // Clear previous messages
        infoForm.style.display = 'none';

        if (!license_id) {
            showAlert("Please enter a License ID.", "warning");
            return;
        }

        try {
            // Placeholder API call from your second code block
            const response = await fetch("/api/check_license", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ license_id })
            });

            const result = await response.json();

            if (!result.allowed) {
                showAlert("License ID not allowed to vote.", "danger");
                return;
            }

            if (result.submitted) {
                showAlert("You have already cast your vote.", "info");
                return;
            }

            // If allowed and not submitted, show the submission form
            licenseForm.style.display = 'none';
            infoForm.style.display = 'block';

        } catch (err) {
            showAlert("Network error. Could not verify license ID.", "danger");
        }
    }

    async function submitForm() {
        const license_id = document.getElementById("license_id").value.trim();
        const name = document.getElementById("name").value.trim();
        const cid = document.getElementById("cid").value.trim();
        const selected_option = document.getElementById("selectInput").value;

        document.getElementById("alert-placeholder").innerHTML = ''; // Clear previous messages

        if (!name || !cid || !selected_option) {
            showAlert("Please fill in all fields before submitting your vote.", "warning");
            return;
        }

        try {
            // Placeholder API call from your second code block
            const response = await fetch("/api/submit_form", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    license_id,
                    name,
                    cid,
                    selected_option
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert("Submission successful! Your vote has been recorded.", "success");
                document.getElementById("info-form").style.display = 'none';
            } else {
                showAlert("Submission error. Please try again.", "danger");
            }

        } catch (err) {
            showAlert("Network error during submission.", "danger");
        }
    }
    </script>
</body>
</html>
